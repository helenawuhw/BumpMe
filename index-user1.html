<!DOCTYPE html>
<html>
<head>
	<!-- capital one key: 4251fb7f94e1e834bdaae6f55dd61b48 -->
	<meta charset="utf-8">
	<title>BumpUp</title>
	<script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
	<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
	<link rel="stylesheet" href="odometer-theme-default.css" />
	<script src="odometer.min.js"></script>
</head>
<body>
	
	<div class='odometer'>
		111
	</div>
	<button id="button">
		Get my Balance
	</button>
	<div id = 'message'>
	</div>

	<script>
		var initialDataLoaded = false;
		var user = "user1";
		var against_user = "user2";
		var unit = 0.01;
		var apikey = '4251fb7f94e1e834bdaae6f55dd61b48';
		var accountId = '5712bd2f01c7065b0fceb52a';
		var payee_accountId = "5712d9d801c7065b0fceb542";
		var db = new Firebase('https://bumpup.firebaseio.com/');
		 // with jQuery
		
		   	$.ajax({
		    url: 'http://api.reimaginebanking.com/accounts/' + accountId + '?key='+apikey,
		    success: function(results){
		        balance = results['balance'];
				$('.odometer').text(balance);
		    }});
		
		db.on('child_added', function(new_event){
			if (initialDataLoaded){
					var msg = new_event.val();
				var calorie_diff;
				console.log(msg.userone.name);
				if(msg.userone.name == user){
					calorie_diff = msg.userone.calorie - msg.usertwo.calorie; // self comes first
				}
				else{
					calorie_diff = msg.usertwo.calorie - msg.userone.calorie; // self comes first
				}
				console.log(calorie_diff);
				if (calorie_diff < 0){
					console.log("i pay");
					// you gotta pay the other one;
					transfer = parseFloat(calorie_diff * unit);
					var d = new Date();
					var date = d.getFullYear() + '-' + ('0' + String(d.getMonth()+1)).slice(-2) + '-' + d.getDate();

					var datum = JSON.stringify({
					  	"medium": "balance",
					  	"payee_id": payee_accountId,
					  	"transaction_date": date,
					  	"description": "run",
					  	"amount": Math.abs(transfer)
					});
					console.log(datum);
					$.ajax({
						url:'http://api.reimaginebanking.com/accounts/'+ accountId + '/transfers?key=' + apikey,
						data: datum,
						type:'POST',
						contentType:'application/json',
						success: function (dat) {
		                	$('#message').html(dat.message);
	            		}
			    	});
				}
					
				
			    function waitAjax(){
			    	$.ajax({
			    	url: 'http://api.reimaginebanking.com/accounts/' + accountId + '?key='+apikey,
			    	success: function(results){
			    	console.log('ss');
			        balance = results['balance'];  
			    }});
			    }

			   	function updateBalance(){
			   		var value = balance;
			   		var id = setInterval(function(){
			   			if(value!=balance){
			   				$('.odometer').text(balance);
			   				clearInterval(id);
			   			}
			   			else{
			   				waitAjax();
			   			}
			   		}, 1000);

			   	}

			   	// Delete setTimeout after working
			   	updateBalance();
				
			}
			
		})
	db.once('value', function(snapshot) {
		  initialDataLoaded = true;
		});
	</script>
</body>
<html>
